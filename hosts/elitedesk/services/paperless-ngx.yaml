services:
  db:
    container_name: paperless-ngx-postgresql
    image: docker.io/library/postgres:15
    restart: unless-stopped
    env_file:
      - .env
    environment:
      POSTGRES_DB: paperless
      POSTGRES_USER: paperless
      POSTGRES_PASSWORD: paperless
    volumes:
      - ${CONFIG_DIR}/paperless-ngx/postgres:/var/lib/postgresql/data
  broker:
    container_name: paperless-ngx-redis
    image: docker.io/library/redis:7
    restart: unless-stopped
    env_file:
      - .env
    volumes:
      - ${CONFIG_DIR}/paperless-ngx/redis:/data
  gotenberg:
    container_name: paperless-ngx-gotenberg
    image: docker.io/gotenberg/gotenberg:8.7
    restart: unless-stopped
    env_file:
      - .env
    command:
      - gotenberg
      - --chromium-disable-javascript=true
      - --chromium-allow-list=file:///tmp/.*
  tika:
    container_name: paperless-ngx-tika
    image: ghcr.io/paperless-ngx/tika:latest
    restart: unless-stopped
    env_file:
      - .env
  webserver:
    container_name: paperless-ngx
    image: ghcr.io/paperless-ngx/paperless-ngx:latest
    restart: unless-stopped
    env_file:
      - .env
    depends_on:
      - db
      - broker
      - gotenberg
      - tika
    environment:
      PAPERLESS_REDIS: redis://broker:6379
      PAPERLESS_DBHOST: db
      PAPERLESS_TIKA_ENABLED: 1
      PAPERLESS_TIKA_GOTENBERG_ENDPOINT: http://gotenberg:3000
      PAPERLESS_TIKA_ENDPOINT: http://tika:9998
      PAPERLESS_OCR_USER_ARGS: '{"invalidate_digital_signatures": true}'
    volumes:
      - ${DATA_DIR}/documents/data:/usr/src/paperless/data
      - ${DATA_DIR}/documents/media:/usr/src/paperless/media
      - ${DATA_DIR}/documents/export:/usr/src/paperless/export
      - ${DATA_DIR}/documents/consume:/usr/src/paperless/consume
    ports:
      - ${PAPERLESS_NGX_PORT}:8000
    healthcheck:
      test: curl -fs -S --max-time 2 http://localhost:8000 || exit 1
      interval: 30s
      timeout: 10s
      retries: 5
